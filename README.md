<h1>Airflow DAG для обновления данных в DWH за определенное время</h1>

<p>
  Запрос <code>f"https://api.moysklad.ru/api/remap/1.2/entity/demand?expand=positions&limit=100&fields=stock&filter=moment>={time_d}"</code> возвращает данные по отгрузкам и их позициям после заданной даты (<code>time_d</code>), что позволяет обновить две таблицы:
  <ul>
    <li><strong>demands</strong>: общая информация о отгрузках (1 строка — 1 отгрузка)</li>
    <li><strong>demand_positions</strong>: данные по позициям отгрузок (1 строка — 1 товар)</li>
  </ul>
  Обновление происходит каждый час путём удаления старых и загрузки новых строк, где удалённые данные соответствуют заданному периоду и полученным ID. <br>
  Обновление данных выполняется с выгрузкой всех записей за период, так как использование поля <code>updated</code> не позволяет получить удалённые записи. <br>
  Этот метод имеет ограничения, но позволяет поддерживать актуальность данных в DWH для решения текущих задач в небольшой компании.
</p>

<h2>demands: описание таблицы</h2>
<ul>
  <li><strong>id</strong> — Уникальный идентификатор документа.</li>
  <li><strong>account_id</strong> — Идентификатор учётной записи в МойСклад.</li>
  <li><strong>shared</strong> — Флаг, указывающий, является ли документ общедоступным.</li>
  <li><strong>updated</strong> — Дата и время последнего обновления документа.</li>
  <li><strong>name</strong> — Название или номер документа.</li>
  <li><strong>description</strong> — Описание или комментарий к документу.</li>
  <li><strong>moment</strong> — Дата и время создания или проведения документа.</li>
  <li><strong>applicable</strong> — Флаг, указывающий, проведён ли документ (актуален к учёту).</li>
  <li><strong>demand_sum</strong> — Общая сумма по документу отгрузки.</li>
  <li><strong>created</strong> — Дата и время создания документа.</li>
  <li><strong>printed</strong> — Флаг, указывающий, был ли документ распечатан.</li>
  <li><strong>published</strong> — Флаг, указывающий, опубликован ли документ для внешнего доступа.</li>
  <li><strong>vat_enabled</strong> — Флаг, указывающий, используется ли НДС в документе.</li>
  <li><strong>pay_sum</strong> — Сумма оплаты, связанная с данным документом.</li>
  <li><strong>demand_type</strong> — Тип документа отгрузки (например, «Отгрузка», «Возврат» и т.д.).</li>
  <li><strong>owner_id</strong> — Идентификатор владельца документа (например, сотрудника).</li>
  <li><strong>owner_type</strong> — Тип владельца документа (например, пользователь, организация и т.д.).</li>
  <li><strong>group_id</strong> — Идентификатор отдела или подразделения, связанного с документом.</li>
  <li><strong>store_id</strong> — Идентификатор склада, с которого происходит отгрузка.</li>
  <li><strong>agent_id</strong> — Идентификатор контрагента, которому осуществляется отгрузка.</li>
  <li><strong>organization_id</strong> — Идентификатор организации, от имени которой создаётся документ.</li>
  <li><strong>agent_account_id</strong> — Идентификатор счёта контрагента для оплаты.</li>
  <li><strong>state</strong> — Статус документа (например, «В работе», «Выполнено» и т.д.).</li>
  <li><strong>shipment_address</strong> — Адрес доставки, указанный в документе.</li>
  <li><strong>project_id</strong> — Идентификатор проекта, с которым связан документ.</li>
  <li><strong>customer_order_id</strong> — Идентификатор связанного заказа покупателя.</li>
  <li><strong>customer_order_type</strong> — Тип связанного заказа покупателя.</li>
  <li><strong>channel_id</strong> — Идентификатор канала продаж, связанного с документом.</li>
  <li><strong>vat_included</strong> — Флаг, указывающий, включён ли НДС в сумму документа.</li>
  <li><strong>vat_sum</strong> — Сумма НДС по документу.</li>
  <li><strong>contract_id</strong> — Идентификатор договора с контрагентом.</li>
  <li><strong>organization_account_id</strong> — Идентификатор счёта организации для проведения платежей.</li>
  <li><strong>overhead_sum</strong> — Сумма накладных расходов, связанных с документом.</li>
  <li><strong>overhead_distribution</strong> — Метод распределения накладных расходов.</li>
  <li><strong>costs</strong> — Детализированные затраты, связанные с документом.</li>
</ul>

<h2>demand_positions: описание таблицы</h2>
<ul>
  <li><strong>id</strong> — Уникальный идентификатор позиции в отгрузке.</li>
  <li><strong>account_id</strong> — Идентификатор учётной записи в МойСклад для позиции.</li>
  <li><strong>quantity</strong> — Количество товаров в данной позиции отгрузки.</li>
  <li><strong>price</strong> — Цена за единицу товара в позиции отгрузки.</li>
  <li><strong>discount</strong> — Размер скидки на товар в позиции отгрузки (доля, например 7% = 0.07).</li>
  <li><strong>vat</strong> — Сумма НДС, применённого к товару в позиции отгрузки.</li>
  <li><strong>vat_enabled</strong> — Флаг, указывающий, применяется ли НДС к товару в позиции отгрузки.</li>
  <li><strong>overhead</strong> — Дополнительные накладные расходы, связанные с позицией отгрузки.</li>
  <li><strong>product_id</strong> — Идентификатор товара, к которому относится позиция.</li>
  <li><strong>assortment_href</strong> — Ссылка на ассортимент товара в МойСклад или внешней системе.</li>
  <li><strong>cost</strong> — Суммарная себестоимость товаров в позиции отгрузки.</li>
  <li><strong>demand_id</strong> — Идентификатор документа отгрузки, к которому относится позиция.</li>
  <li><strong>demand_name</strong> — Название или номер документа отгрузки, к которому относится позиция.</li>
  <li><strong>moment</strong> — Дата и время создания или проведения документа отгрузки.</li>
  <li><strong>applicable</strong> — Флаг, указывающий, проведён ли документ отгрузки (актуален к учёту).</li>
  <li><strong>demand_state</strong> — Статус документа отгрузки, с которым связана эта позиция.</li>
  <li><strong>pack_quantity</strong> — Количество товаров в упаковке для данной позиции.</li>
  <li><strong>stock_quantity</strong> — Общее количество товара в наличии на складе для данной позиции.</li>
  <li><strong>stock_reserve</strong> — Количество товара, зарезервированного на складе для данной позиции.</li>
  <li><strong>stock_intransit</strong> — Количество товара, находящегося в пути на склад для данной позиции.</li>
  <li><strong>stock_available</strong> — Количество товара, доступного для продажи или отгрузки.</li>
  <li><strong>pack_type</strong> — Тип упаковки товара для данной позиции.</li>
</ul>

